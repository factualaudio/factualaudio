#!/bin/bash

# Concatenates multiple file assets (typically, CSS and JS) into single files.
# This script takes as input a manifest generated by generate-concatenate-manifest.xsl.

set -e
set -o pipefail
shopt -s nullglob

[[ "$#" -eq 2 ]]

BASEDIR="$1"
BASEURL="$2"

while read -r OUTPUT_FILE
do
	OUTPUT_PATH="${OUTPUT_FILE#"$BASEURL"}"
	[[ "$OUTPUT_PATH" != "$OUTPUT_FILE" ]]

	echo -n "$OUTPUT_PATH: "
	INPUTS=()
	while read -r INPUT_FILE
	do
		[[ -z "$INPUT_FILE" ]] && break
		INPUT_PATH="${INPUT_FILE#"$BASEURL"}"
		[[ "$INPUT_PATH" != "$INPUT_FILE" ]]
		echo -n "$INPUT_PATH "
		INPUTS+=("$BASEDIR/$INPUT_PATH")
	done
	echo

	cat "${INPUTS[@]}" > "$BASEDIR/$OUTPUT_PATH"
	rm "${INPUTS[@]}"
done
