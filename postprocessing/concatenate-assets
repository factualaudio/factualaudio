#!/bin/bash

# Concatenates multiple file assets (typically, CSS and JS) into single files.
# This script takes as input a manifest generated by generate-concatenate-manifest.xsl.

set -e
set -o noclobber
set -o pipefail
shopt -s nullglob

[[ "$#" -eq 2 ]]

BASEDIR="$1"
BASEURL="$2"

while read -r OUTPUT_URL
do
	echo -n "$OUTPUT_URL"
	OUTPUT_FILE="${OUTPUT_URL#"$BASEURL"}"
	[[ "$OUTPUT_URL" != "$OUTPUT_FILE" ]]
	echo " > $OUTPUT_FILE"
	OUTPUT_FILE="$BASEDIR/$OUTPUT_FILE"

	{
		INPUTS=()
		while read -r INPUT_URL
		do
			[[ -z "$INPUT_URL" ]] && break
			echo "  $INPUT_URL" 
			INPUT_FILE="${INPUT_URL#"$BASEURL"}"
			if [[ "$INPUT_FILE" != "$INPUT_URL" ]]
			then
				echo "    < $INPUT_FILE"
				INPUT_FILE="$BASEDIR/$INPUT_FILE"
				cat "$INPUT_FILE" >&"$OUTPUT_FD"
				rm "$INPUT_FILE"
			else
				curl --fail --url "$INPUT_URL" >&"$OUTPUT_FD"
			fi
		done
	} {OUTPUT_FD}>"$OUTPUT_FILE"
done
